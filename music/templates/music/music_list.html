{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>éŸ³ä¹æ’­æ”¾å¹³å° - é¦–é¡µ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å¼•å…¥å…¨å±€åŸºç¡€CSS -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <!-- å¼•å…¥åˆ—è¡¨é¡µä¸“å±CSS -->
    <link rel="stylesheet" href="{% static 'css/music_list.css' %}">
</head>
<body>
    <!-- çœ‰é¡µéŸ³é¢‘æ’­æ”¾å™¨å®¹å™¨ -->
    <div id="header-audio-player" class="header-audio-player">
        <div class="player-content">
            <div class="now-playing">
                <div class="playing-icon">ğŸµ</div>
                <div class="playing-info">
                    <div id="now-playing-name" class="playing-name">æœªé€‰æ‹©æ­Œæ›²</div>
                    <div id="now-playing-singer" class="playing-singer">-</div>
                </div>
            </div>
            <div class="player-controls">
                <button id="header-prev-btn" class="control-btn" title="ä¸Šä¸€é¦–">â®</button>
                <button id="header-play-pause-btn" class="control-btn play-pause-btn" title="æ’­æ”¾">â–¶</button>
                <button id="header-next-btn" class="control-btn" title="ä¸‹ä¸€é¦–">â­</button>
                <div class="progress-container">
                    <input type="range" id="header-progress-bar" class="progress-bar" min="0" max="100" value="0">
                    <div class="time-display">
                        <span id="header-current-time">0:00</span> / 
                        <span id="header-duration">0:00</span>
                    </div>
                </div>
                <div class="volume-container">
                    <span class="volume-icon">ğŸ”Š</span>
                    <input type="range" id="header-volume-bar" class="volume-bar" min="0" max="100" value="100">
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨å±€éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆéšè—ï¼Œä»…ç”¨äºéŸ³é¢‘æ’­æ”¾é€»è¾‘ï¼‰ -->
    <audio id="global-audio" preload="metadata" style="display: none;"></audio>

    <div class="header">
        <h1>éŸ³ä¹æ’­æ”¾å¹³å°</h1>
        <a href="{% url 'import_music' %}" class="btn">å¯¼å…¥æœ¬åœ°éŸ³ä¹</a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="message message-success">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if musics %}
        <div class="table-container">
            <table class="music-table">
                <thead>
                    <tr>
                        <th>åºå·</th>
                        <th>æ­Œæ›²å</th>
                        <th>æ­Œæ‰‹</th>
                        <th>ä¸“è¾‘</th>
                        <th>æ·»åŠ æ—¶é—´</th>
                        <th>æ–‡ä»¶çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for music in musics %}
                    <tr class="music-item" 
                        data-music-id="{{ music.id }}"
                        data-music-src="{% url 'play_music' music.id %}"
                        data-music-name="{{ music.name }}"
                        data-music-singer="{{ music.singer }}"
                        data-music-album="{{ music.album|default:'æœªçŸ¥ä¸“è¾‘' }}"
                        {% if not music.file_exists %}data-file-exists="false"{% endif %}>
                        <!-- ä¿®æ­£åºå·ï¼šæ˜¾ç¤ºå…¨å±€åºå·ï¼ˆè€Œéæ¯é¡µä»1å¼€å§‹ï¼‰ -->
                        <td class="index">{{ musics.start_index|add:forloop.counter0 }}</td>
                        <td class="name">{{ music.name }}</td>
                        <td class="singer">{{ music.singer }}</td>
                        <td class="album">{{ music.album|default:"æœªçŸ¥ä¸“è¾‘" }}</td>
                        <td class="time">{{ music.created_at|date:"Y-m-d H:i" }}</td>
                        <td class="status">
                            {% if music.file_exists %}
                                <span class="status-ok">âœ“ æ–‡ä»¶å­˜åœ¨</span>
                            {% else %}
                                <span class="status-error">âœ— æ–‡ä»¶ä¸¢å¤±</span>
                            {% endif %}
                        </td>
                        <td class="actions">
                            {% if music.file_exists %}
                                <a href="#" class="play-link" data-music-id="{{ music.id }}">æ’­æ”¾</a>
                            {% else %}
                                <span class="disabled-link">æ— æ³•æ’­æ”¾</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µæ§ä»¶ -->
        <div class="pagination">
            <!-- ä¸Šä¸€é¡µ -->
            {% if musics.has_previous %}
                <a href="?page={{ musics.previous_page_number }}">ä¸Šä¸€é¡µ</a>
            {% else %}
                <a href="#" class="disabled">ä¸Šä¸€é¡µ</a>
            {% endif %}

            <!-- é¡µç åˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼šåªæ˜¾ç¤ºå½“å‰é¡µã€å‰1é¡µã€å1é¡µï¼‰ -->
            {% for num in musics.paginator.page_range %}
                {% if num == musics.number %}
                    <a href="?page={{ num }}" class="active">{{ num }}</a>
                {% elif num > musics.number|add:-2 and num < musics.number|add:2 %}
                    <a href="?page={{ num }}">{{ num }}</a>
                {% endif %}
            {% endfor %}

            <!-- ä¸‹ä¸€é¡µ -->
            {% if musics.has_next %}
                <a href="?page={{ musics.next_page_number }}">ä¸‹ä¸€é¡µ</a>
            {% else %}
                <a href="#" class="disabled">ä¸‹ä¸€é¡µ</a>
            {% endif %}

            <!-- é¡µç ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ -->
            <span class="page-info">
                å…± {{ musics.paginator.count }} é¦– / {{ musics.paginator.num_pages }} é¡µ
            </span>
        </div>

    {% else %}
        <div class="empty-tip">
            <h3>æš‚æ— éŸ³ä¹æ–‡ä»¶</h3>
            <p><a href="{% url 'import_music' %}" class="btn">ç‚¹å‡»å¯¼å…¥æœ¬åœ°éŸ³ä¹</a></p>
        </div>
    {% endif %}

    <!-- å¼•å…¥JavaScriptæ–‡ä»¶ -->
    <script src="{% static 'js/base.js' %}"></script>
    <script src="{% static 'js/music_play.js' %}"></script>
    <script src="{% static 'js/header_player.js' %}"></script>
    
    <!-- CSRF token ç”¨äºAJAXè¯·æ±‚ -->
    <script>
        // è·å–CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
    </script>
</body>
</html>